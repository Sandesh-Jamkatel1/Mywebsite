<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music and Voice Mixer with Equalizer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        input, button, audio, p {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #timer {
            font-size: 1.2em;
            text-align: center;
        }

        /* Mobile Styling */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            button, input {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Music and Voice Mixer with Equalizer</h1>

        <!-- Music Input -->
        <label for="musicFile">Select Music File:</label>
        <input type="file" id="musicFile" accept="audio/*">
        <audio id="musicPlayer" controls></audio>

        <!-- Equalizer Controls -->
        <div class="equalizer">
            <div>
                <label for="bassControl">Bass</label>
                <input type="range" id="bassControl" min="-40" max="40" value="0">
            </div>
            <div>
                <label for="midControl">Mid</label>
                <input type="range" id="midControl" min="-40" max="40" value="0">
            </div>
            <div>
                <label for="trebleControl">Treble</label>
                <input type="range" id="trebleControl" min="-40" max="40" value="0">
            </div>
        </div>

        <!-- Voice Recorder Controls -->
        <button id="startRecording">Start Recording</button>
        <button id="pauseRecording" disabled>Pause Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
        <audio id="recordedAudio" controls></audio>
        <p id="timer">00:00</p>

        <!-- Play Combined Audio and Save it -->
        <button id="combineAudio">Play Combined Audio</button>
        <button id="saveAudio">Save Combined Audio</button>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let musicAudioBuffer, recordedChunks = [];
        let musicSource, voiceSource; // Store the audio sources for simultaneous playback
        let isPlaying = false; // Track if the audio is playing
        let startTime = 0; // Track when playback started
        let pauseTime = 0; // Track the time at which audio was paused

        // Equalizer setup
        const bassControl = document.getElementById('bassControl');
        const midControl = document.getElementById('midControl');
        const trebleControl = document.getElementById('trebleControl');
        let bassFilter, midFilter, trebleFilter;

        // Create filters for the equalizer
        function createFilters() {
            bassFilter = audioContext.createBiquadFilter();
            bassFilter.type = 'lowshelf'; // Bass frequencies
            bassFilter.frequency.value = 200;

            midFilter = audioContext.createBiquadFilter();
            midFilter.type = 'peaking'; // Mid frequencies
            midFilter.frequency.value = 1000;

            trebleFilter = audioContext.createBiquadFilter();
            trebleFilter.type = 'highshelf'; // Treble frequencies
            trebleFilter.frequency.value = 3000;

            // Connect the filters in series
            bassFilter.connect(midFilter);
            midFilter.connect(trebleFilter);
            trebleFilter.connect(audioContext.destination);
        }

        // Music Player Setup
        const musicFileInput = document.getElementById('musicFile');
        const musicPlayer = document.getElementById('musicPlayer');

        musicFileInput.addEventListener('change', async function () {
            const file = this.files[0];
            const fileReader = new FileReader();

            fileReader.onload = async function () {
                const arrayBuffer = fileReader.result;

                try {
                    musicAudioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    const url = URL.createObjectURL(file);
                    musicPlayer.src = url; // Set music player source
                } catch (error) {
                    console.error('Error decoding audio data:', error);
                    alert('Error loading music file. Please ensure it is a valid audio file.');
                }
            };

            fileReader.readAsArrayBuffer(file);
        });

        // Voice Recorder Setup
        let mediaRecorder;
        const recordedAudio = document.getElementById('recordedAudio');
        const startRecordingButton = document.getElementById('startRecording');
        const pauseRecordingButton = document.getElementById('pauseRecording');
        const stopRecordingButton = document.getElementById('stopRecording');
        const timerDisplay = document.getElementById('timer');
        let recordingStartTime, recordingTimerInterval;

        startRecordingButton.addEventListener('click', async function () {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            recordedChunks = [];
            recordingStartTime = Date.now();

            mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function () {
                clearInterval(recordingTimerInterval);
                timerDisplay.textContent = '00:00';
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const audioURL = URL.createObjectURL(blob);
                recordedAudio.src = audioURL;
            };

            mediaRecorder.start();
            startRecordingButton.disabled = true;
            pauseRecordingButton.disabled = false;
            stopRecordingButton.disabled = false;

            recordingTimerInterval = setInterval(updateTimer, 1000);
        });

        pauseRecordingButton.addEventListener('click', function () {
            if (mediaRecorder.state === "recording") {
                mediaRecorder.pause();
                pauseRecordingButton.textContent = "Resume Recording";
            } else if (mediaRecorder.state === "paused") {
                mediaRecorder.resume();
                pauseRecordingButton.textContent = "Pause Recording";
            }
        });

        stopRecordingButton.addEventListener('click', function () {
            mediaRecorder.stop();
            startRecordingButton.disabled = false;
            pauseRecordingButton.disabled = true;
            stopRecordingButton.disabled = true;
        });

        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0');
            const seconds = String(elapsedTime % 60).padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }

        // Combine and Play Mixed Audio with Equalizer
        document.getElementById('combineAudio').addEventListener('click', async function () {
            if (!musicAudioBuffer || recordedChunks.length === 0) {
                alert('Please load music and record your voice first!');
                return;
            }

            const recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            const arrayBuffer = await recordedBlob.arrayBuffer();
            const voiceAudioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            // Toggle play/pause functionality
            if (isPlaying) {
                pauseCombinedAudio();
            } else {
                createFilters(); // Create the equalizer filters
                playCombinedAudio(musicAudioBuffer, voiceAudioBuffer, pauseTime);
            }
        });

        function playCombinedAudio(musicBuffer, voiceBuffer, offset) {
            // Stop previous playback if any
            if (musicSource) {
                musicSource.stop(); 
            }
            if (voiceSource) {
                voiceSource.stop();
            }

            // Create new sources for music and voice
            musicSource = audioContext.createBufferSource();
            voiceSource = audioContext.createBufferSource();
            musicSource.buffer = musicBuffer;
            voiceSource.buffer = voiceBuffer;

            // Connect the sources to the equalizer filters
            musicSource.connect(bassFilter);
            voiceSource.connect(bassFilter);

            // Start the audio with offset (for pausing)
            musicSource.start(0, offset);
            voiceSource.start(0, offset);

            startTime = audioContext.currentTime - offset; // Correct time tracking
            isPlaying = true;

            // Equalizer control listeners
            bassControl.addEventListener('input', updateEqualizer);
            midControl.addEventListener('input', updateEqualizer);
            trebleControl.addEventListener('input', updateEqualizer);
        }

        function pauseCombinedAudio() {
            // Pause both music and voice
            if (musicSource && voiceSource) {
                pauseTime = audioContext.currentTime - startTime;
                musicSource.stop();
                voiceSource.stop();
                isPlaying = false;
            }
        }

        function updateEqualizer() {
            // Update the gain values of the filters based on user input
            bassFilter.gain.value = bassControl.value;
            midFilter.gain.value = midControl.value;
            trebleFilter.gain.value = trebleControl.value;
        }

        // Save Mixed Audio
        document.getElementById('saveAudio').addEventListener('click', function () {
            if (recordedChunks.length === 0) {
                alert('No audio to save!');
                return;
            }

            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = 'mixed_audio.webm';
            downloadLink.click();
        });
    </script>

</body>
</html>
